module Imamura1998
  != ¶âÀ±±ÀÈùÊª·×»»¥â¥¸¥å¡¼¥ë
  !
  ! ¸µÏÀÊ¸¡§Imamura and Hashimoto (1998), JGR103, E13, 31349. 
  !
  ! Authors::   SUGIYAMA Ko-ichiro, FUKUHARA Nozomu 
  !

  !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
  implicit none

  !Â°À­¤Î»ØÄê
  private

  !H2SO4 ¿åÍÏ±Õ¤Î¥®¥Ö¥¹¼«Í³¥¨¥Í¥ë¥®¡¼¤òµá¤á¤ë¤¿¤á¤Î·¸¿ô.
  !Zeleznik (1991), J. Phys. Chem. Data ¤Î Table 6 ¤Ë´ð¤Å¤¯.  
  real(8)            :: mu111
  real(8)            :: mu211
  real(8)            :: mu121
  real(8)            :: mu221
  real(8)            :: mu122
  real(8)            :: mu212

  real(8)            :: eps111
  real(8)            :: eps211
  real(8)            :: eps121
  real(8)            :: eps221
  real(8)            :: eps122
  real(8)            :: eps212


  !¶¦ÄÌÊÑ¿ô
  real(8), parameter :: Boltz = 1.38064852d-23  !!Boltzmann constant  
  real(8), parameter :: TempRef = 385.0d0
  real(8), parameter :: TempCr= 647.26d0

  !¸ø³«
  public imamura1998_GibbsRDivRT
  public imamura1998_DelChemPotRDivRT
  public imamura1998_SatPress
  public imamura1998_SatPressRef
  public imamura1998_newton
  public imamura1998_bisection
  public imamura1998_Imamura1998
  public Imamura1998_Sediment
  public Imamura1998_H2SO4Prdt
  public Imamura1998_H2SO4Loss
  
contains

!!!%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

  
  subroutine imamura1998_coefficient( temp )
    !
    !·×»»¤ËÍøÍÑ¤¹¤ë·¸¿ô \mu_{ijk}, \varepsilon_{ijk} ¤ò·×»».
    !Zeleznik (1991), J. Phys. Chem. Data ¤Î Table 6 ¤Ë´ð¤Å¤¯.  
    !·¸¿ô¤Ï²¹ÅÙ¤Î´Ø¿ô. 
    !
    
    ! °ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none
    
    ! ÊÑ¿ôÀë¸À
    real(8), intent(in) :: temp    !! ²¹ÅÙ (temperature)
    
    !H2SO4 ¿åÍÏ±Õ¤Î¥®¥Ö¥¹¼«Í³¥¨¥Í¥ë¥®¡¼¤òµá¤á¤ë¤¿¤á¤Î·¸¿ô.
    real(8), parameter :: mu111_a = -0.235245033870d+2
    real(8), parameter :: mu111_b =  0.406889449841d-1
    real(8), parameter :: mu111_c = -0.151369362907d-4
    real(8), parameter :: mu111_d =  0.296144445015d+4
    real(8), parameter :: mu111_e =  0.492476973663d+0
    real(8), parameter :: mu121_a =  0.111458541077d+4
    real(8), parameter :: mu121_b = -0.118330789360d+1
    real(8), parameter :: mu121_c = -0.209946114412d-2
    real(8), parameter :: mu121_d = -0.246749842271d+6
    real(8), parameter :: mu121_e =  0.341234558134d+2
    real(8), parameter :: mu221_a = -0.801488100747d+2
    real(8), parameter :: mu221_b = -0.116246143257d-1
    real(8), parameter :: mu221_c =  0.606767928954d-5
    real(8), parameter :: mu221_d =  0.309272150882d+4
    real(8), parameter :: mu221_e =  0.127601667471d+2
    real(8), parameter :: mu122_a =  0.888711613784d+3
    real(8), parameter :: mu122_b = -0.250531359687d+1
    real(8), parameter :: mu122_c =  0.605638824061d-3
    real(8), parameter :: mu122_d = -0.196985296431d+6
    real(8), parameter :: mu122_e =  0.745500643380d+2
    real(8), parameter :: eps111_a =  0.288731663295d+4
    real(8), parameter :: eps111_b = -0.332602457749d+1
    real(8), parameter :: eps111_c = -0.282047283300d-2
    real(8), parameter :: eps111_d = -0.528216112353d+6
    real(8), parameter :: eps111_e =  0.686997433564d+0
    real(8), parameter :: eps211_a =  0.383025318809d+2
    real(8), parameter :: eps211_b = -0.295997878789d-1
    real(8), parameter :: eps211_c =  0.120999746782d-4
    real(8), parameter :: eps211_d = -0.324697498999d+4
    real(8), parameter :: eps211_e = -0.383566039532d+1
    real(8), parameter :: eps121_a = -0.370944593249d+3
    real(8), parameter :: eps121_b = -0.690310834523d+0
    real(8), parameter :: eps121_c =  0.563455068422d-3
    real(8), parameter :: eps121_d = -0.382252997064d+4
    real(8), parameter :: eps121_e =  0.942682037574d+2
    real(8), parameter :: eps221_a =  0.232476399402d+4
    real(8), parameter :: eps221_b = -0.141626921317d+0
    real(8), parameter :: eps221_c = -0.626760562881d-2
    real(8), parameter :: eps221_d = -0.450590687961d+6
    real(8), parameter :: eps221_e = -0.612339472744d+2
    real(8), parameter :: eps122_a = -0.163385547832d+4
    real(8), parameter :: eps122_b = -0.335344369968d+1
    real(8), parameter :: eps122_c =  0.710978119903d-2
    real(8), parameter :: eps122_d =  0.198200003569d+6
    real(8), parameter :: eps122_e =  0.246693619189d+3 
    real(8), parameter :: eps212_a =  0.127375159848d+4
    real(8), parameter :: eps212_b =  0.103333898148d+1
    real(8), parameter :: eps212_c =  0.341400487633d-2
    real(8), parameter :: eps212_d =  0.195290667051d+6
    real(8), parameter :: eps212_e = -0.431737442782d+3
  
    !·¸¿ô \mu_ijk ¤Î·×»»
    mu111 =   mu111_a               &
      &     + mu111_b * temp        &
      &     + mu111_c * temp* temp  &
      &     + mu111_d / temp        &
      &     + mu111_e * dlog(temp)
    mu121 =   mu121_a               &
      &     + mu121_b * temp        &
      &     + mu121_c * temp* temp  &
      &     + mu121_d / temp        &
      &     + mu121_e * dlog(temp)
    mu221 =   mu221_a               &
      &     + mu221_b * temp        &
      &     + mu221_c * temp* temp  &
      &     + mu221_d / temp        &
      &     + mu221_e * dlog(temp)
    mu122 =   mu122_a               &
      &     + mu122_b * temp        &
      &     + mu122_c * temp* temp  &
      &     + mu122_d / temp        &
      &     + mu122_e * dlog(temp)
    mu211 = mu121
    mu212 = mu122
    
    !·¸¿ô \varepsilon_ijk ¤Î·×»»
    eps111 =   eps111_a              &
      &      + eps111_b * temp       &
      &      + eps111_c * temp* temp &
      &      + eps111_d / temp       &
      &      + eps111_e * dlog(temp)
    eps121 =   eps121_a              &
      &      + eps121_b * temp       &
      &      + eps121_c * temp* temp &
      &      + eps121_d / temp       &
      &      + eps121_e * dlog(temp)
    eps211 =   eps211_a              &
      &      + eps211_b * temp       &
      &      + eps211_c * temp* temp &
      &      + eps211_d / temp       &
      &      + eps211_e * dlog(temp)
    eps221 =   eps221_a              &
      &      + eps221_b * temp       &
      &      + eps221_c * temp* temp &
      &      + eps221_d / temp       &
      &      + eps221_e * dlog(temp)
    eps122 =   eps122_a              &
      &      + eps122_b * temp       &
      &      + eps122_c * temp* temp &
      &      + eps122_d / temp       &
      &      + eps122_e * dlog(temp)
    eps212 =   eps212_a              &
      &      + eps212_b * temp       &
      &      + eps212_c * temp* temp &
      &      + eps212_d / temp       &
      &      + eps212_e * dlog(temp)
    
  end subroutine imamura1998_coefficient
  
  
  subroutine imamura1998_SatPressRef( TempIN, SatPress1, SatPress2 )
    !
    !Ë°ÏÂ¾øµ¤°µ(Ã±À®Ê¬)¤Î·×»».     
    !
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none
    
    !ÊÑ¿ôÀë¸À
    real(8), intent(in)    :: TempIN  !! ²¹ÅÙ
                                      !! temperature
    real(8), intent(out)   :: SatPress1
    real(8), intent(out)   :: SatPress2
    real(8), parameter     :: alpha = 24.021415d0
    real(8), parameter     :: beta  = 4616.9134d0
    real(8), parameter     :: gamm  = 3.1934553d-4
    real(8), parameter     :: delta = 2.7550431d-11
    real(8), parameter     :: eps   = 1.0131374d-2
    real(8), parameter     :: ita   = 1.3158813d-2
    real(8)                :: xi
    real(8)                :: zeta
    real(8)                :: Temp
    real(8)                :: TempRefDivTemp
    real(8)                :: Log_SatPressRef1
    real(8)                :: Log_SatPressRef2    
    
    !²¹ÅÙ¤Ï TempCr °Ê¾å¤Ï¼è¤ì¤Ê¤¤.
    Temp = min(TempIN, TempCr)

    !!
    !! H2SO4 ¤ÎË°ÏÂ¾øµ¤°µ 
    !!

    ! Äê¿ô¤ÎÀßÄê
    xi   = ( ( Temp + 0.01d0 ) ** 2.0d0 ) - 293700.0d0
    zeta = (TempCr - Temp) ** 1.25d0  
    TempRefDivTemp = TempRef / Temp 
    
    ! H2SO4 (½ãÊª¼Á) ¤ÎË°ÏÂ¾øµ¤°µ (Ã±°Ì : bar )
    ! ¤Ê¤¼¤« log 2Äì¤Ê¤Î¤Ç....
    !    Log_SatPressRef1 = - ( 10156.0d0 / Temp ) + 16.259d0
    Log_SatPressRef1 = &         
      & +  16.259d0 &
      & -  10156.0d0 / Temp  &
      & +  7.42d0 * ( 1.0d0 + log( TempRefDivTemp ) / log(2.0d0) - TempRefDivTemp )
    
    ! H2SO4 (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ (Ã±°Ì : Pa)
    SatPress1 = exp( Log_SatPressRef1 ) * 1.0d5
    
    !!
    !! H20 ¤ÎË°ÏÂ¾øµ¤°µ 
    !!
    
    ! H2O (½ãÊª¼Á) ¤ÎË°ÏÂ¾øµ¤°µ (Ã±°Ì : Pa)
    Log_SatPressRef2 = &
      &   alpha &
      & - beta / Temp &
      & + gamm * xi * ( dexp( delta * ( xi ** 2.0d0 ) ) - 1.0d0 ) / (Temp + 0.01d0) &
      & - eps * dexp( -1.0d0 * ita * zeta )
    
    ! H2O (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ
    SatPress2 = exp( Log_SatPressRef2 )
    
  end subroutine Imamura1998_SatPressRef
  

  subroutine imamura1998_SatPress( Temp, con, SatPress1, SatPress2 )
    !
    ! H2SO4 ¿åÍÏ±Õ¤ÎË°ÏÂ¾øµ¤°µ
    !

    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !ÊÑ¿ôÀë¸À
    real(8), intent(in)    :: con   !! H2SO4 ¿åÍÏ±Õ¤ÎÇ»ÅÙ
                                    !! concentration of H2SO4 solution
    real(8), intent(in)    :: Temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(out)   :: SatPress1
    real(8), intent(out)   :: SatPress2
    real(8)                :: SatPressRef1
    real(8)                :: SatPressRef2    
    real(8)                :: DelChemPotRDivRT1
    real(8)                :: DelChemPotRDivRT2 

    !½ãÊª¼Á¤ÎË°ÏÂ¾øµ¤°µ
    call imamura1998_SatPressRef( Temp, SatPressRef1, SatPressRef2 )
    
    !º®¹ç¤Î²½³Ø¥Ý¥Æ¥ó¥·¥ã¥ëÊÑ²½¤ò·×»»
    call imamura1998_DelChemPotRDivRT( &
      & Temp, con, DelChemPotRDivRT1, DelChemPotRDivRT2 )

    ! H2SO4 (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ
    SatPress1 = SatPressRef1 * exp( DelChemPotRDivRT1 )
    
    ! H2O (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ
    SatPress2 = SatPressRef2 * exp( DelChemPotRDivRT2 )
    
  end subroutine Imamura1998_SatPress
  

  subroutine imamura1998_GibbsRDivRT( temp, con, GibbsRDivRT ) 
    !
    ! - G^{(r)} / RT ¤Î·×»».
    ! G^{(r)} = G - G^{\circ}(T,p,x)
    ! (G^{(r)} : relative molar Gibbs energy of aquenous sulfuric asid)
    !
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !°ú¿ô¤ÎÀë¸À
    real(8), intent(in)    :: con   !! H2SO4 ¿åÍÏ±Õ¤ÎÇ»ÅÙ
                                    !! concentration of H2SO4 solution
    real(8), intent(in)    :: temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(out)   :: GibbsRDivRT

    
    !ÊÑ¿ô¤ÎÀë¸À
    real(8)                :: x1, x2

    !¥â¥ëÈæ¤¬¥Þ¥·¥ó¥¤¥×¥·¥í¥ó¤è¤ê¾®¤µ¤¤¾ì¹ç¤Î½èÍý.
    !\ln(0.0) ¤ÏÈ¯»¶¤¹¤ë¤Î¤Ç. 
    x1 = max( epsilon(con), con )
    x1 = min( 1.0d0 - epsilon(x1), x1 )

    ! H2SO4 ¤È H2O ¤Î¥â¥ëÈæ
    x2 = 1.0d0 - x1

    !·¸¿ô¤ò·è¤á¤ë
    call imamura1998_coefficient(temp)   

    !-\frac{G^{(r)}}{RT}
    !  = \sum^2_{i=1} \Phi_{i} \sum^2_{j=1}\sum^2_{k=1}
    !     (\mu_{jki} + \varepsilon_{jki} \ln x_{j}) x_j x_k
    !
    ! mu112 = mu222 = eps112 = eps122 = 0.0
    ! Ph1_1 = 1, Phi2 = x1 * x2
    !
    GibbsRDivRT =                                                 &
      & -1.0d0 * (                                                &
      &    (                                                      & !i=1
      &       + ( mu111 + eps111 * dlog(x1) ) * x1 * x1           &   !j=1,k=1
      &       + ( mu121 + eps121 * dlog(x1) ) * x1 * x2           &   !j=1,k=2
      &       + ( mu211 + eps211 * dlog(x2) ) * x2 * x1           &   !j=2,k=1
      &       + ( mu221 + eps221 * dlog(x2) ) * x2 * x2           &   !j=2,k=2
      &    )                                                      &
      &  +                                                        &
      &    (                                                      & !i=2
      &       + ( mu122 + eps122 * dlog(x1) ) * x1 * x1 * x2 * x2 &   !j=1,k=2
      &       + ( mu212 + eps212 * dlog(x2) ) * x1 * x1 * x2 * x2 &   !j=2,k=1
      &    )                                                      &
      & )
    
  end subroutine imamura1998_GibbsRDivRT
  

  subroutine imamura1998_DelChemPotRDivRT( &
    & temp, con, DelChemPotRDivRT1, DelChemPotRDivRT2 ) 
    !
    ! \frac{\Del\mu_{i}}{RT} = \frac{\mu_i(T,x_i) - \mu^{\circ}(T)}{RT}
    ! = (G^{(r)} - x_1 \DP{G^{(r)}}{x_1} - x_2 \DP{G^{(r)}}{x_2} + \DP{G^{(r)}}{x_i})/RT
    !    
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !°ú¿ô¤ÎÀë¸À
    real(8), intent(in)    :: con   !! H2SO4 ¿åÍÏ±Õ¤ÎÇ»ÅÙ
                                    !! concentration of H2SO4 solution
    real(8), intent(in)    :: temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(out)   :: DelChemPotRDivRT1
    real(8), intent(out)   :: DelChemPotRDivRT2

    !ÊÑ¿ô¤ÎÀë¸À 
    real(8)                :: GibbsRDivRT
    real(8)                :: DGibbsRDivRT_Dx1
    real(8)                :: DGibbsRDivRT_Dx2
    real(8)                :: x1, x2
    
    !¥â¥ëÈæ¤¬¥Þ¥·¥ó¥¤¥×¥·¥í¥ó¤è¤ê¾®¤µ¤¤¾ì¹ç¤Î½èÍý.
    !\ln(0.0) ¤ÏÈ¯»¶¤¹¤ë¤Î¤Ç. 
    x1 = max( epsilon(con), con )
    x1 = min( 1.0d0 - epsilon(x1), x1 )
    
    ! H2SO4 ¤È H2O ¤Î¥â¥ëÈæ
    x2 = 1.0d0 - x1

    !·¸¿ô¤ò·è¤á¤ë
    call imamura1998_coefficient(temp)

    ! ´Ø¿ô¤Î¸Æ¤Ó½Ð¤·
    call imamura1998_GibbsRDivRT(temp, con, GibbsRDivRT)
   
    ! \DP{G^{(r)}/RT}{x_1} 
    DGibbsRDivRT_Dx1 =                                               &
         & -1.0d0 * (                                                &
         &  (                                                        & !i=1
         &    + ( mu111 + eps111 * dlog(x1) ) * x1 * 2.0d0           &   !j=1,k=1 
         &              + eps111 * x1                                &
         &    + ( mu121 + eps121 * dlog(x1) ) * x2                   &   !j=1,k=2
         &              + eps121 * x2                                &
         &    + ( mu211 + eps211 * dlog(x2) ) * x2                   &   !j=2,k=1
         &  )                                                        &
         &  +                                                        &
         &  (                                                        & !i=2
         &    + ( mu122 + eps122 * dlog(x1) ) * x1 * x2 * x2 * 2.0d0 &   !j=1,k=2
         &              + eps122 * x1 * x2 * x2                      &
         &    + ( mu212 + eps212 * dlog(x2) ) * x1 * x2 * x2 * 2.0d0 &   !j=2,k=1
         &  )                                                        &
         & )

    ! \DP{G^{(r)}/RT}{x_2} 
    DGibbsRDivRT_Dx2 =                                               &
         & -1.0d0 * (                                                &
         &  (                                                        & !i=1
         &    + ( mu121 + eps121 * dlog(x1) ) * x1                   &   !j=1,k=2
         &    + ( mu211 + eps211 * dlog(x2) ) * x1                   &   !j=2,k=1
         &              + eps211 * x1                                &
         &    + ( mu221 + eps221 * dlog(x2) ) * x2 * 2.0d0           &   !j=2,k=2
         &              + eps221 * x2                                &
         &  )                                                        &
         &  +                                                        &
         &  (                                                        & !i=2
         &   + ( mu122 + eps122 * dlog(x1) ) * x1 * x1 * x2 * 2.0d0  &   !j=1,k=2
         &   + ( mu212 + eps212 * dlog(x2) ) * x1 * x1 * x2 * 2.0d0  &   !j=2,k=1
         &             + eps212 * x1 * x1 * x2                       &
         &  )                                                        &
         & )
    
    DelChemPotRDivRT1 =                   &
         &  min(   0.0d0,                   &
         &       + GibbsRDivRT            &
         &       - x1 * DGibbsRDivRT_Dx1  &
         &       - x2 * DGibbsRDivRT_Dx2  &
         &       + DGibbsRDivRT_Dx1 )

    DelChemPotRDivRT2 =   &
         &  min(   0.0d0, &
         &       + GibbsRDivRT            &
         &       - x1 * DGibbsRDivRT_Dx1  &
         &       - x2 * DGibbsRDivRT_Dx2  &
         &       + DGibbsRDivRT_Dx2 )
    
  end subroutine imamura1998_DelChemPotRDivRT

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!    

  subroutine imamura1998_DDelChemPotRDivRTDx( &
       & temp, con, DDelChemPotRDivRT1_Dx1, DDelChemPotRDivRT2_Dx1 )
    !
    ! \frac{\Del\mu_{i}}{RT} = \frac{\mu_i(T,x_i) - \mu^{\circ}(T)}{RT}
    ! = (G^{(r)} - x_1 \DP{G^{(r)}}{x_1} - x_2 \DP{G^{(r)}}{x_2} + \DP{G^{(r)}}{x_i})/RT
    ! x1 ÈùÊ¬
    !
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !°ú¿ô¤ÎÀë¸À
    real(8), intent(in)    :: con   !! H2SO4 ¿åÍÏ±Õ¤ÎÇ»ÅÙ
                                    !! concentration of H2SO4 solution
    real(8), intent(in)    :: temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(out)   :: DDelChemPotRDivRT1_Dx1
    real(8), intent(out)   :: DDelChemPotRDivRT2_Dx1

    !ÊÑ¿ô¤ÎÀë¸À
    real(8)                :: GibbsRDivRT
    real(8)                :: DGibbsRDivRT_Dx1Dx1
    real(8)                :: DGibbsRDivRT_Dx1Dx2
!    real(8)                :: DGibbsRDivRT_Dx2Dx2
    real(8)                :: x1, x2
    
    !¥â¥ëÈæ¤¬¥Þ¥·¥ó¥¤¥×¥·¥í¥ó¤è¤ê¾®¤µ¤¤¾ì¹ç¤Î½èÍý.
    !\ln(0.0) ¤ÏÈ¯»¶¤¹¤ë¤Î¤Ç. 
    x1 = max( epsilon(con), con )
    x1 = min( 1.0d0 - epsilon(x1), x1 )
    
    ! H2SO4 ¤È H2O ¤Î¥â¥ëÈæ
    x2 = 1.0d0 - x1

!    write(*,*) con
    
    !·¸¿ô¤ò·è¤á¤ë
    call imamura1998_coefficient(temp)

    ! DP{\DP{G^{(r)}/RT}{x_1}}{x_1}
    DGibbsRDivRT_Dx1Dx1 =                                                         &
         &    - ( mu111 + eps111 * dlog(x1) ) * 2.0d0                             &   !j=1,k=1 
         &    -           eps111              * 3.0d0                             &
         &    + ( mu121 + eps121 * dlog(x1) )                                     &   !j=1,k=2
         &    -           eps121              * ( x2 / x1  - 1.0d0 )              &
         &    + ( mu211 + eps211 * dlog(x2) )                                     &   !j=2,k=1
         &    +           eps211                                                  &
         &    - ( mu122 + eps122 * dlog(x1) ) * x2 * (1.0d0 - x1 * 3.0d0) * 2.0d0 &   !j=1,k=2
         &    -           eps122              * x2 * (3.0d0 - 5.0d0 * x1)         &
         &    - ( mu212 + eps212 * dlog(x2) ) * x2 * (1.0d0 - x1 * 3.0d0) * 2.0d0 &   !j=2,k=1
         &    +           eps212              * x1 * x2 * 2.0d0                      !j=2,k=1

    ! \DP{\DP{G^{(r)}/RT}{x_1}}{x_2}
    DGibbsRDivRT_Dx1Dx2 =                                                         &
         &    - ( mu121 + eps121 * dlog(x1) )                                     &   !j=1,k=2
         &    -           eps121                                                  &
         &    - ( mu211 + eps211 * dlog(x2) )                                     &   !j=2,k=1
         &    +           eps211              * (x1 / x2 - 1.0d0)                 &
         &    + ( mu221 + eps221 * dlog(x2) ) * 2.0d0                             &   !j=2,k=2
         &    +           eps221              * 3.0d0                             &
         &    - ( mu122 + eps122 * dlog(x1) ) * x1 * (2.0d0 - 3.0d0 * x1) * 2.0d0 &   !j=1,k=2
         &    -           eps122              * x1 * x2 * 2.0d0                   &   !j=1,k=2
         &    - ( mu212 + eps212 * dlog(x2) ) * x1 * (2.0d0 - 3.0d0 * x1) * 2.0d0 &   !j=2,k=1
         &    +           eps212              * x1 * ( 5.0d0 * x1 - 2.0d0 )

    DDelChemPotRDivRT1_Dx1 = + x2 * DGibbsRDivRT_Dx1Dx1  &
         &                   - x2 * DGibbsRDivRT_Dx1Dx2  
    
    DDelChemPotRDivRT2_Dx1 = - x1 * DGibbsRDivRT_Dx1Dx1  &
         &                   + x1 * DGibbsRDivRT_Dx1Dx2
    
  end subroutine imamura1998_DDelChemPotRDivRTDx
  
  

  subroutine imamura1998_newton( NumDens1, NumDens2, Temp, con, SatPress1, SatPress2, Flag )

    !°ÅÌÛ¤Î·¿Àë¸À
    implicit none

    !ÊÑ¿ôÀë¸À
    real(8), intent(inout) :: con   !! H2SO4 ¿åÍÏ±Õ¤ÎÇ»ÅÙ
                                    !! concentration of H2SO4 solution
    real(8), intent(in)    :: Temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(in)    :: NumDens1, NumDens2
    logical, intent(out)   :: Flag
    real(8)                :: Func, DFuncDx1
    real(8)                :: SatPress1, SatPress2
    real(8)                :: DSatPress1Dx1, DSatPress2Dx1
    real(8)                :: DDelChemPotRDivRT1_Dx1, DDelChemPotRDivRT2_Dx1
    real(8)                :: DelChemPotRDivRT1, DelChemPotRDivRT2
    real(8)                :: BoltzTemp
    real(8)                :: x1, x1A, x1P, x1L, x1R
    integer                :: CalNum
    integer, parameter     :: MaxNum = 10
    real(8)                :: x1save
    real(8)                :: gosa(10)
    
    !½é´ü²½
    CalNum = 0
    x1save = con
    
    !Äê¿ô¤ÎÀßÄê
    BoltzTemp = Boltz * Temp
    
    !ÊÑ¿ôÌ¾¤ÎÃÖ¤­´¹¤¨
    x1 = con
    
    Loop: do
      !¥ë¡¼¥×²ó¿ô
      CalNum = CalNum + 1
      
      !¿åÍÏ±Õ¤ÎË°ÏÂ¾øµ¤°µ
      call imamura1998_SatPress( Temp, x1, SatPress1, SatPress2 )
      
      !º®¹ç¤Î²½³Ø¥Ý¥Æ¥ó¥·¥ã¥ë¤Î x1 ÈùÊ¬¤ò·×»»
      call imamura1998_DDelChemPotRDivRTDx( &
        & Temp, x1, DDelChemPotRDivRT1_Dx1, DDelChemPotRDivRT2_Dx1 )
      
      !H2SO4 (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ¤Î x1 (H2SO4 ¥â¥ëÈæ) ÈùÊ¬
      DSatPress1Dx1 = DDelChemPotRDivRT1_Dx1 * SatPress1
      
      !H2O (ÍÏ±Õ) ¤ÎË°ÏÂ¾øµ¤°µ¤Î x1 (H2SO4 ¥â¥ëÈæ) ÈùÊ¬
      DSatPress2Dx1 = DDelChemPotRDivRT2_Dx1 * SatPress2       
      
      !´Ø¿ô
      Func = &
        &   ( 1.0d0 - x1 ) * (NumDens1 - SatPress1 / BoltzTemp ) &
        & - x1             * (NumDens2 - SatPress2 / BoltzTemp )
      
      !´Ø¿ô¤Î x1 ¤Ë´Ø¤¹¤ë 1 ³¬ÈùÊ¬
      DFuncDx1 = &
        & - ( NumDens1 - SatPress1 / BoltzTemp ) &
        & - ( NumDens2 - SatPress2 / BoltzTemp ) &
        & - ( 1.0d0 - x1 ) * DSatPress1Dx1 / BoltzTemp  &
        & +   x1           * DSatPress2Dx1 / BoltzTemp         
      
      !¿¿¤Ë¶á¤¤²ò. ÃÍ¤Ï 0 ~ 1 ¤ÎÈÏ°Ï. 
      x1A =  x1 - Func / DFuncDx1
      
      !¼¡¤ÎÃÍ¤¬ x1 ¤ÎËþ¤¿¤¹¤Ù¤­ÈÏ°Ï 0 <= x1 <= 1 ¤òÄ¶¤¨¤¿¾ì¹ç¤Î½èÃÖ.
      if (x1A >= 1.0d0 ) then 
        !          write(*,*) "CALL Bisection (1)"
        x1L = x1
        x1R = 1.0d0
        call imamura1998_bisection  &
          & (NumDens1, NumDens2, Temp, x1L, x1R, con, SatPress1, SatPress2, Flag)
        exit Loop
      end if
!       if (x1A <= 0.0d0 ) then 
!          write(*,*) "CALL Bisection (2)"
!          x1L = 0.0d0
!          x1R = x1
!          call imamura1998_bisection(NumDens1, NumDens2, Temp, x1L, x1R, con, Flag)
!          exit Loop
!       end if

      !¥ë¡¼¥×¤Î½ªÎ»¾ò·ï
      if ( abs((x1A - x1) / x1) < 1.0d-12 .OR. CalNum > MaxNum ) then 
        
        if( NumDens1 - SatPress1 / BoltzTemp > 0 .AND. NumDens2 - SatPress2 / BoltzTemp > 0) then
          !
          ! ¶Å·ë¤Î¾ò·ï¤¬ OK ¤Î»þ¤Î½èÍý
          !
          con = x1A
          Flag = .true.
          
        elseif( abs(NumDens1 - SatPress1 / BoltzTemp) / NumDens1 < 1.0d-7 .OR. abs(NumDens2 - SatPress2 / BoltzTemp)/NumDens2 < 1.0d-7 .OR. CalNum > MaxNum .OR. x1A > 1.0d0 .OR. x1A < 0.0d0) then
          !
          ! ÀºÅÙ¤ò³ÎÊÝ¤¹¤ë¤¿¤á¤Ë, ÆóÊ¬Ë¡¤Ç¤â¥À¥á¤«Ç°²¡¤·¤¹¤ë.
          !
          !             write(*,*) "CALL Bisection (3)"
          x1L = max(0.0d0, x1save - 1.0d-1)
          x1R = min(1.0d0, x1save + 1.0d-1)
          call imamura1998_bisection &
            & (NumDens1, NumDens2, Temp, x1L, x1R, con, SatPress1, SatPress2, Flag)
          
        else
          !
          ! ¶Å·ë¤Î¾ò·ï¤òËþ¤¿¤»¤Ê¤¤¾ì¹ç¤Î½èÍý
          !
          con = -1.0d0
          Flag = .true.
        end if
        exit
      end if
      
      !¥ë¡¼¥×¤ò²ó¤¹¤¿¤á¤Î½èÍý
      x1P = x1
      x1  = x1A
      
    end do Loop
    
  end subroutine Imamura1998_Newton
  
  
  subroutine imamura1998_bisection &
    & ( NumDens1, NumDens2, Temp, x1L, x1R, x1C, SatPress1, SatPress2, Flag )

    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !ÊÑ¿ôÀë¸À
    real(8), intent(inout) :: x1L, x1R, x1C    !! H2SO4 ¤Î¥â¥ëÈæ 
    real(8), intent(in)    :: Temp  !! ²¹ÅÙ
                                    !! temperature
    real(8), intent(in)    :: NumDens1, NumDens2

    real(8), intent(out)   :: SatPress1, SatPress2
    logical, intent(out)   :: Flag
    real(8)                :: FuncL, FuncC, FuncR
    real(8)                :: BoltzTemp
    real(8)                :: Func
    integer                :: CalNum
    integer                :: i

    !½é´ü²½
    CalNum = 0
    Flag = .false.
    
    !Äê¿ô¤ÎÀßÄê
    BoltzTemp = Boltz * Temp

    !°Ê²¼¤Î¾ò·ï¤¬Æ±»þ¤ËËþ¤¿¤µ¤ì¤Ê¤¤¤È¤¤¤±¤Ê¤¤.
    ! NumDens1 - SatPress1 / BoltzTemp > 0
    ! NumDens2 - SatPress2 / BoltzTemp > 0
    
    Loop: do
      !¥ë¡¼¥×²ó¿ô
      CalNum = CalNum + 1
      
      !ÃæÅÀ. ¿¿¤Ë¶á¤¤²ò
      x1C = ( x1R + x1L ) * 5.0d-1
!       write(*,*) CalNum, real(x1C), real(abs((x1R - x1L) / x1R))

      !´Ø¿ô
      call imamura1998_SatPress( Temp, x1L, SatPress1, SatPress2 )
      FuncL = &
        &  ( 1.0d0 - x1L ) * max( (NumDens1 - SatPress1 / BoltzTemp ), 0.0d0) &
        & - x1L            * max( (NumDens2 - SatPress2 / BoltzTemp ), 0.0d0)
      
      call imamura1998_SatPress( Temp, x1R, SatPress1, SatPress2 )
      FuncR = &
        &  ( 1.0d0 - x1R ) * max( (NumDens1 - SatPress1 / BoltzTemp ), 0.0d0 ) &
        & - x1R            * max( (NumDens2 - SatPress2 / BoltzTemp ), 0.0d0 )
      
      call imamura1998_SatPress( Temp, x1C, SatPress1, SatPress2 )
      FuncC = &
        &  ( 1.0d0 - x1C ) * max( (NumDens1 - SatPress1 / BoltzTemp ), 0.0d0 ) &
        & - x1C            * max( (NumDens2 - SatPress2 / BoltzTemp ), 0.0d0 )
      
      !¥ë¡¼¥×¤ò²ó¤¹¤¿¤á¤Î½èÍý
      if ( FuncL * FuncC < 0.0d0 ) then 
        x1R = x1C          
      elseif ( FuncC * FuncR < 0.0d0 ) then
        x1L = x1C
      end if
      
      !¥ë¡¼¥×¤Î½ªÎ»¾ò·ï
      if ( abs((x1R - x1L) / x1R) < 1.0d-12 .OR. CalNum >= 60 .OR. FuncC == 0.0d0 ) then 
        
        if( NumDens1 - SatPress1 / BoltzTemp > 0 .AND. NumDens2 - SatPress2 / BoltzTemp > 0) then
          ! ¶Å·ë¤Î¾ò·ï¤òËþ¤¿¤·¤Æ¤¤¤ë¾ì¹ç¤Ï x1C ¤òÌá¤êÃÍ¤È¤¹¤ë. 
          flag = .true.
          
        else
          ! ¶Å·ë¤Î¾ò·ï¤òËþ¤¿¤·¤Æ¤¤¤Ê¤¤¾ì¹ç¤Ï flag ¤ò .false. ¤Ë¤¹¤ë.
          x1C = -1.0d0
          flag = .false.
        end if
        exit
      end if
      
       
    end do Loop
    
  end subroutine Imamura1998_Bisection
  

!!!
!!! ¤Þ¤È¤á¤Æ²ò¤¯¤¿¤á¤Î¥×¥í¥°¥é¥à
!!!
  subroutine Imamura1998_Imamura1998( Temp, n1, n2, n1_gas, n2_gas, n1_liq, n2_liq, con, sw, flag )

    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !ÊÑ¿ôÀë¸À
    real(8), intent(in)  :: Temp
    real(8), intent(in)  :: n1, n2
    integer, intent(in)  :: sw
    real(8), intent(out) :: n1_gas, n2_gas, n1_liq, n2_liq, con
    logical, intent(out) :: flag    
    
    integer              :: j 
    integer, parameter   :: NumTest = 6
    integer              :: idx(1), cnt(1)
    real(8)              :: FuncSign(NumTest)
    real(8)              :: FuncTest1, FuncTest2
    real(8)              :: del = 1.0d0 / real(NumTest - 1)
    real(8), parameter   :: TempCr= 647.26d0
    real(8)              :: x1N   
    real(8)              :: SatPressRef1, SatPressRef2
    real(8)              :: SatPress1, SatPress2
    real(8)              :: x1R, x1L

    !½é´ü²½
    flag = .true. 
    
    !¥Ç¡¼¥¿¤Î¤¢¤¿¤ê¤òÉÕ¤±¤ë.      
    do j = 1, NumTest
      con = real(j-1) * del
      call imamura1998_SatPress( Temp, con, SatPress1, SatPress2)
      
      FuncTest2 = &
        &   ( 1.0d0 - con ) * max( (n1 - SatPress1 / ( boltz * Temp ) ), 0.0d0 ) &
        & -   con           * max( (n2 - SatPress2 / ( boltz * Temp ) ), 0.0d0 )
      
      if ( j==1 ) FuncTest1 = FuncTest2
      
      FuncSign(j)= FuncTest1 * FuncTest2
      FuncTest1  = FuncTest2        
    end do
    
    ! 0 <= x1 <= 1 ¤ÎÈÏ°Ï¤Ë²ò¤¬¤¢¤ë¤Î¤Ê¤é,
    ! dx ´Ö³Ö¤ÇÎÙÆ±»Î¤Î³Ý¤±»» (ex. Func(0) * Func(0.2)) ¤ÇÉé¤Ë¤Ê¤ë¤Î¤Ï°ì²Õ½ê.
    ! Éé¤Ë¤Ê¤ë²Õ½ê¤ÎÇÛÎóÅº¤¨»ú¤Ï 1 °Ê²¼¤Ë¤Ê¤é¤Ê¤¤. 
    !
    cnt = count( FuncSign < 0.0d0)
    idx = minloc(FuncSign, FuncSign < 0.0d0)
    
    ! ¤â¤·¤â 0 <= x1 <= 1 ¤ÎÈÏ°Ï¤Ë²ò¤¬¤¢¤ë¤È¤¤¤¦¾ò·ï¤òËþ¤¿¤µ¤Ê¤¤¤Ê¤é¤Ð,
    ! ¿åÍÏ±Õ¤ÏÀ¸À®¤µ¤ì¤Ê¤¤. ½ãÊª¼Á¤ÎË°ÏÂ¾ò·ï¤Î¤ß¹ÍÎ¸¤¹¤ì¤ÐÎÉ¤¤. 
    if ( (cnt(1) /= 1 .OR. idx(1) <= 1) .OR. n1 == 0.0d0 .OR. n2 == 0.0d0 ) then
      !
      !¿åÍÏ±Õ¤¬¶Å·ë¤·¤Ê¤¤¾ì¹ç.
      !
      
      call imamura1998_SatPressRef( Temp, SatPressRef1, SatPressRef2)
      
      con = -1.0d0
      
      if ( n1 > (SatPressRef1 / ( boltz * Temp ))) then 
        n1_gas =      SatPressRef1 / ( boltz * Temp )
        n1_liq = n1 - SatPressRef1 / ( boltz * Temp ) 
        n2_gas = n2
        n2_liq = 0.0d0
      elseif ( n2 > (SatPressRef2 / ( boltz * Temp ))) then 
        n1_gas = n1
        n1_liq = 0.0d0
        n2_gas =      SatPressRef2 / ( boltz * Temp )
        n2_liq = n2 - SatPressRef2 / ( boltz * Temp )
      else
        n1_gas = n1
        n1_liq = 0.0d0
        n2_gas = n2
        n2_liq = 0.0d0
      end if
      
    else     
      
      !
      !¿åÍÏ±Õ¤¬¶Å·ë¤¹¤ë¾ì¹ç
      !
      
      !ÆóÊ¬Ë¡¤Î½é´üÃÍ
      x1L = real(idx(1)-2) * del
      x1R = real(idx(1)-1) * del
      
      if ( sw == 1 ) then 
        !ÆóÊ¬Ë¡¤Ç·×»»
        call imamura1998_bisection(n1, n2, Temp, x1L, x1R, con, SatPress1, SatPress2, flag)
      else
        ! ¥Ë¥å¡¼¥È¥óË¡¤Î½é´üÃÍ
        con = (real(idx(1)-2) + real(idx(1)-1))* del * 5.0d-1
        call imamura1998_newton(n1, n2, Temp, con, SatPress1, SatPress2, flag)
      end if
      
      ! ¶Å·ëÎÌ¤Î·×»»
!      call imamura1998_SatPress( Temp, con, SatPress1, SatPress2)
      if ( n1 > (SatPress1 / ( boltz * Temp )) .AND. n2 > (SatPress2 / ( boltz * Temp ))) then 
        n1_gas =       SatPress1 / ( boltz * Temp )
        n1_liq =  n1 - SatPress1 / ( boltz * Temp )
        n2_gas =       SatPress2 / ( boltz * Temp )
        n2_liq =  n2 - SatPress2 / ( boltz * Temp )                   
      else
        n1_gas = n1
        n1_liq = 0.0d0
        n2_gas = n2
        n2_liq = 0.0d0
      end if
    end if
    
  end subroutine Imamura1998_Imamura1998
  

  subroutine Imamura1998_Sediment(Height, VelZ)

    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none

    !ÊÑ¿ôÀë¸À
    real(8), intent(in)  :: Height
    real(8), intent(out) :: VelZ
    real(8), parameter   :: Grav = 8.7d0
    real(8), parameter   :: Dens = 1.8d3
    real(8), parameter   :: R_2  = 1.15d-6  !¥â¡¼¥É2 ¤ÎÈ¾·Â
    real(8), parameter   :: R_3  = 3.65d-6
    real(8), parameter   :: Vis  = 1.5d-5
    real(8)              :: Molfr_2, Molfr_3
    real(8)              :: VelZ_2,  VelZ_3
    
    !mode3 ¤ÎÊ¬ÉÛ¤ò tanh ¤Ç¶á»÷
    Molfr_3 = 0.455d0 * tanh( 57.5d3 - Height ) + 0.455d0
    
    !mode2 ¤ÎÊ¬ÉÛ
    Molfr_2 = 1.d0 - Molfr_3
    
    !mode 2, 3 ¤ÎÂ®ÅÙ
    VelZ_3  = - 2.0d0 * Grav * Dens * R_3 * R_3 / Vis / 9.0d0
    VelZ_2  = - 2.0d0 * Grav * Dens * R_2 * R_2 / Vis / 9.0d0
    
    !Ê¿¶ÑÂ®ÅÙ
    VelZ = Molfr_2 * VelZ_2 + Molfr_3 * VelZ_3
    
  end subroutine Imamura1998_Sediment
  
  
  subroutine Imamura1998_H2SO4Prdt( Height, DelZ, H2SO4_Prdt, H2O_Loss )
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none
    
    !ÊÑ¿ôÀë¸À
    real(8), intent(in) :: Height
    real(8), intent(in) :: DelZ
    real(8), intent(out):: H2SO4_Prdt 
    real(8), intent(out):: H2O_Loss
    
    real(8), parameter  :: PI = 3.1415926535897932d0
    real(8), parameter  :: phi = 30.0d0 * PI / 180.0d0
    real(8), parameter  :: sigma = 1.5d3
    real(8), parameter  :: Height0 = 62.0d3
    real(8)             :: DH
    
    DH = Height - Height0
    
    !Ã±°Ì¤òÂ·¤¨¤ë¤¿¤á¤Ë DelZ ¤Ç³ä¤ê»»¤·¤Æ¤ª¤¯É¬Í×¤¬¤¢¤ë¤Ï¤º.
    !
    H2SO4_Prdt = & 
      & 3.5d0  * 1.0d16  / sigma / sqrt( 2.0d0 * PI ) &
      & * exp( -1.0d0 * DH * DH  / ( 2.0d0 * sigma * sigma ) ) &
      & * cos( Phi ) / DelZ
    
    H2O_Loss = -1.0d0 * H2SO4_Prdt
    
  end subroutine Imamura1998_H2SO4Prdt
  
  
  subroutine Imamura1998_H2SO4Loss( Temp, Press, n1, n2, H2SO4_Loss, H2O_Prdt )
    
    !°ÅÌÛ¤Î·¿Àë¸À¶Ø»ß
    implicit none
    
    !ÊÑ¿ôÀë¸À
    real(8), intent(in) :: Temp
    real(8), intent(in) :: Press
    real(8), intent(in) :: n1, n2      !¿ôÌ©ÅÙ
    real(8), intent(out):: H2SO4_Loss
    real(8), intent(out):: H2O_Prdt
    
    real(8), parameter  :: k13 = 5.5d-29
    real(8), parameter  :: f_co = 25.0d-6  !°ÞÅÙ > 35
!     real(8), parameter  :: f_co = 30.0d-6  !35 < °ÞÅÙ < 60
!     real(8), parameter  :: f_co = 35.0d-6  !°ÞÅÙ > 60
    real(8)              :: mean
    real(8)              :: kp
    
    !ºî¶ÈÊÑ¿ô
    mean = press / (Boltz * Temp)
    kp = 10.0d0 ** ( 7.584d0 - ( 5060.0d0 / Temp ) )
    
    !H2SO4 ¤Î¾ÃÌÇ¹à
    H2SO4_Loss = f_co * k13 * kp * mean * mean  * n1 / n2 / press
    
    !H2O ¤ÎÀ¸À®¹à
    H2O_Prdt = -1.0d0 * H2SO4_Loss
    
  end subroutine Imamura1998_H2SO4Loss
  
end module imamura1998
